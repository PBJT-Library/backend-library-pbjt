# ⚠️ DEPRECATED - Use Prisma migrations instead
# This script is kept as reference only
#
# To run migrations, use:
#   bun run db:migrate:deploy    # Production
#   bun run db:migrate:dev       # Development
#
# See: https://www.prisma.io/docs/concepts/components/prisma-migrate

# PowerShell Migration Script
# Run migration without interactive password prompt

$ErrorActionPreference = "Stop"

Write-Host "==========================================" -ForegroundColor Cyan
Write-Host "PBJT Library Database Migration v1 to v2" -ForegroundColor Cyan
Write-Host "==========================================" -ForegroundColor Cyan
Write-Host ""

# ❌ SECURITY ISSUE: Password should NEVER be hardcoded
# Use environment variables or prompt user instead
# Database credentials from .env
$DB_HOST = "localhost"
$DB_PORT = "5432"
$DB_NAME = "library_db"
$DB_USER = "postgres"  
$DB_PASSWORD = Read-Host "Enter PostgreSQL password" -AsSecureString

Write-Host "Database: $DB_NAME" -ForegroundColor Yellow
Write-Host "Host: ${DB_HOST}:${DB_PORT}" -ForegroundColor Yellow
Write-Host "User: $DB_USER" -ForegroundColor Yellow
Write-Host ""

# Convert secure string to plain text for psql
$BSTR = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($DB_PASSWORD)
$PlainPassword = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR)

# Set PGPASSWORD environment variable
$env:PGPASSWORD = $PlainPassword

try {
    Write-Host "⚠️ NOTE: This script is deprecated!" -ForegroundColor Yellow
    Write-Host "Use 'bun run db:migrate:deploy' instead" -ForegroundColor Yellow
    Write-Host ""
    
    Write-Host "Step 1: Running migration..." -ForegroundColor Green
    psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f "src/database/migration_v1_to_v2.sql"
    
    Write-Host ""
    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Host "Migration Summary" -ForegroundColor Cyan
    Write-Host "==========================================" -ForegroundColor Cyan
    
    psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -c "SELECT (SELECT COUNT(*) FROM book_catalog) as catalog_count, (SELECT COUNT(*) FROM book_inventory) as inventory_count, (SELECT COUNT(*) FROM books) as original_books, (SELECT COUNT(*) FROM loans WHERE inventory_id IS NOT NULL) as loans_migrated;"
    
    Write-Host ""
    Write-Host "✅ Migration completed successfully!" -ForegroundColor Green
}
catch {
    Write-Host "❌ Migration failed: $_" -ForegroundColor Red
    exit 1
}
finally {
    # Clear password from environment
    Remove-Item Env:\PGPASSWORD
    [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($BSTR)
}
